<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Material Requirements</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; background:#f4f6f9; margin:0; }
    .navbar { background:#2a5298; padding:10px; display:flex; align-items:center; }
    .navbar button { background:#fff; border:none; margin-right:10px; padding:8px 12px; border-radius:4px; cursor:pointer; }
    .navbar button:hover { background:#ddd; }
    .profile { color:#fff; cursor:pointer; font-weight:bold; }
    .dropdown { display:none; position:absolute; right:0; top:40px; background:#fff; border:1px solid #ccc; border-radius:6px; padding:10px; z-index:1000; }
    .main-content { padding:20px; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    table, th, td { border:1px solid #ccc; }
    th, td { padding:8px; text-align:left; }
    th { background:#eee; }
    button.remove-btn { background:#e74c3c; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; }
    button.remove-btn:hover { background:#c0392b; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <button onclick="navigate('home.html')">Dashboard</button>
    <button onclick="navigate('pending.html')">Pending Works</button>
    <button onclick="navigate('completed.html')">Completed Works</button>
    <button onclick="navigate('material.html')">Material Requirements</button>
    <button onclick="navigate('report.html')">Daily Report</button>
    <button onclick="navigate('admin.html')">Admin Panel</button>

    <div class="profile" id="profile" style="margin-left:auto;position:relative;">
      <span id="usernameDisplay"></span>
      <div class="dropdown" id="dropdownMenu">
        <button onclick="logout()">Logout</button><br>
        <button onclick="changePassword()">Change Password</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <h2>Material Requirements</h2>
    <p><strong>Today's Date:</strong> <span id="liveDate"></span></p>

    <!-- Data Entry Form -->
    <form id="materialForm">
      <label>Material Name:</label><br>
      <input type="text" id="matName" required><br><br>

      <label>Item Code:</label><br>
      <input type="text" id="matCode" required><br><br>

      <label>Quantity:</label><br>
      <input type="number" id="matQty" required><br><br>

      <label>Required Date:</label><br>
      <input type="date" id="matDate" required><br><br>

      <label>Raised By:</label><br>
      <input type="text" id="matAssigned" required><br><br>

      <button type="submit">Add Material Requirement</button>
    </form>

    <!-- Table -->
    <table id="material-table">
      <thead>
        <tr>
          <th>Material Name</th>
          <th>Item Code</th>
          <th>Quantity</th>
          <th>Required Date</th>
          <th>Raised By</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const loggedUser = localStorage.getItem("loggedUser");
    document.getElementById("usernameDisplay").textContent = loggedUser || "Guest";

    // Live date
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("liveDate").textContent = today;
    document.getElementById("matDate").value = today; // auto-fill today's date in form

    // Dropdown toggle
    document.getElementById("profile").addEventListener("click", (e) => {
      e.stopPropagation();
      const menu = document.getElementById("dropdownMenu");
      menu.style.display = menu.style.display === "none" ? "block" : "none";
    });
    document.addEventListener("click", () => {
      document.getElementById("dropdownMenu").style.display = "none";
    });

    function logout() { localStorage.removeItem("loggedUser"); window.location.href = "login.html"; }
    function changePassword() {
      const users = JSON.parse(localStorage.getItem("users")) || {};
      const newPass = prompt("Enter new password:");
      if (newPass) {
        users[loggedUser].password = newPass;
        localStorage.setItem("users", JSON.stringify(users));
        alert("Password updated!");
      }
    }
    function navigate(page) { window.location.href = page; }

    // Load materials
    let materials = JSON.parse(localStorage.getItem("materialRequirements")) || [];
    const tbody = document.querySelector("#material-table tbody");

    function renderMaterials() {
      tbody.innerHTML = "";
      if (materials.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="6" style="text-align:center;color:#888;">No material requirements</td>`;
        tbody.appendChild(row);
      } else {
        materials.forEach((item, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.code}</td>
            <td>${item.quantity}</td>
            <td>${item.date}</td>
            <td>${item.assignedBy}</td>
            <td>${loggedUser === "dhanumisal" 
                  ? `<button class="remove-btn" onclick="removeMaterial(${index})">Remove</button>` 
                  : `<span style="color:#888;">Only admin can remove</span>`}
            </td>
          `;
          tbody.appendChild(row);
        });
      }
    }
    renderMaterials();

    // Add new material
    document.getElementById("materialForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const newMat = {
        name: document.getElementById("matName").value,
        code: document.getElementById("matCode").value,
        quantity: document.getElementById("matQty").value,
        date: document.getElementById("matDate").value,
        assignedBy: document.getElementById("matAssigned").value
      };
      materials.push(newMat);
      localStorage.setItem("materialRequirements", JSON.stringify(materials));
      this.reset();
      document.getElementById("matDate").value = today; // reset date to today
      renderMaterials();
    });

    // Remove material (admin only)
    function removeMaterial(index) {
      if (loggedUser !== "dhanumisal") {
        alert("Access denied! Only admin can remove material requirements.");
        return;
      }
      if (confirm("Are you sure you want to remove this material requirement?")) {
        materials.splice(index, 1);
        localStorage.setItem("materialRequirements", JSON.stringify(materials));
        renderMaterials();
      }
    }
  </script>
</body>
</html>
